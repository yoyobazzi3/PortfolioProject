<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio</title>
    <link rel="stylesheet" href="home.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.4.0/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <nav class="navbar">
        <ul>
            <li><a href="#" id="homeLink">Home</a></li>
            <li><a href="#" id="aboutLink">About</a></li>
            <li><a href="#" id="resumeLink">Resume</a></li>
            <li><a href="#" id="blogLink">Blog</a></li>
        </ul>
    </nav>

    <div class="container" id="imgBox">
        <div id="prevText"></div>
        <textarea id="textBox" placeholder="Add Caption"></textarea>

        <input type="file" accept="image/*" name="image" id="file" style="display: none" onchange="loadFile(event)">
        <label for="file"><img src="images/upload.png" class="upload-icon"></label>

        <!-- Save button -->
        <button id="saveButton" class="save-btn">Save</button>
        <!-- Export button -->
        <button id="exportButton" class="save-btn">Export to PDF</button>
    </div>

    <script>
        // Extract the username from the URL query parameters
        const queryParams = new URLSearchParams(window.location.search);
        const username = queryParams.get('name');

        // Update navbar links to include the username in query parameters
        if (username) {
            document.getElementById("homeLink").href = `portfolio?name=${username}`;
            document.getElementById("aboutLink").href = `about?name=${username}`;
            document.getElementById("resumeLink").href = `resume?name=${username}`;
        }

        const textBox = document.getElementById("textBox");
        const imgBox = document.getElementById("imgBox");
        const saveButton = document.getElementById("saveButton");
        const prevText = document.getElementById("prevText");
        const fileInput = document.getElementById("file");
        const exportButton = document.getElementById("exportButton");

        // Display the typed caption in real-time
        textBox.addEventListener("input", () => {
            prevText.innerText = textBox.value;
        });

        // Update the background image of imgBox when an image is selected
        const loadFile = function(event) {
            imgBox.style.backgroundImage = "url(" + URL.createObjectURL(event.target.files[0]) + ")";
        };

        // Load saved data (caption and image) from server on page load
        if (username) {
            fetch(`/api/userdata?name=${username}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error(data.error);
                    } else {
                        if (data.caption) {
                            textBox.value = data.caption;
                            prevText.innerText = data.caption;
                        }
                        if (data.profileFile) {
                            imgBox.style.backgroundImage = `url(/uploads/${data.profileFile})`;
                        }
                    }
                })
                .catch(error => console.error('Error fetching user data:', error));
        }

        // Save button click handler to save caption and image
        saveButton.addEventListener("click", () => {
            const formData = new FormData();
            formData.append("username", username);
            formData.append("caption", textBox.value);

            if (fileInput.files.length > 0) {
                formData.append("profileFile", fileInput.files[0]);
            }

            fetch('/api/save', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert("Your changes have been saved!");
                } else {
                    console.error("Error saving data:", data.error);
                }
            })
            .catch(error => console.error('Error:', error));
        });

        // Export button click handler to export the content as a PDF
        exportButton.addEventListener("click", () => {
            const { jsPDF } = window.jspdf;

            html2canvas(imgBox).then(canvas => {
                const pdf = new jsPDF();
                const imgData = canvas.toDataURL("image/png");

                pdf.addImage(imgData, "PNG", 10, 10, 190, 0);
                pdf.save("Portfolio.pdf");
            }).catch(error => {
                console.error('Error exporting to PDF:', error);
            });
        });
        
    </script>
</body>
</html>
